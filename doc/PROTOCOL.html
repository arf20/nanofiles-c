<h1 id="nanofiles-c-protocol-specification">nanofiles-c protocol
specification</h1>
<h3 id="notation">Notation</h3>
<ul>
<li>asdf: static data</li>
<li>&lt; &gt;: mandatory field</li>
<li>[ ]: optional field</li>
<li>[…]: last object N times</li>
<li>All sizes are in bytes</li>
</ul>
<h2 id="directory-protocol">Directory protocol</h2>
<p>UTF-8 encoded text/plain in key:value format over simple UDP</p>
<h3 id="client-requests">Client requests</h3>
<h4 id="ping-request">Ping request</h4>
<p>Test the connection and compatibility</p>
<ul>
<li>Operation <code>ping</code></li>
<li>Fields
<ul>
<li><code>protocol id</code></li>
</ul></li>
<li>Answer ‘ping reply’</li>
</ul>
<pre><code>operation:ping
[protocol:&lt;protocol id&gt;]
</code></pre>
<h4 id="filelist-request">Filelist request</h4>
<p>Get file information known by directory</p>
<ul>
<li>Operation <code>filelist</code></li>
<li>Fields: None</li>
<li>Answer ‘filelist reply [bad]’</li>
</ul>
<pre><code>operation:filelist
</code></pre>
<h4 id="publish-requst">Publish requst</h4>
<p>Inform directory of list available files for download from client</p>
<ul>
<li>Operation <code>publish</code></li>
<li>Fields: (see below), the list can be empty</li>
<li>Answer ‘publish response’</li>
</ul>
<pre><code>operation: publish
[port: &lt;port&gt;]
&lt;filename1&gt;: &lt;size1&gt;; &lt;hash1&gt;
&lt;filename2&gt;: &lt;size2&gt;; &lt;hash2&gt;
[...]
</code></pre>
<h3 id="directory-responses">Directory responses</h3>
<h4 id="ping-reply">Ping reply</h4>
<p>Acknoledges back connection and informs client of compatibility</p>
<ul>
<li>Operation <code>pingOk</code></li>
<li>Fields: None</li>
<li>Answer to ‘ping request’</li>
</ul>
<pre><code>operation:pingOk
</code></pre>
<h4 id="filelist-reply">Filelist reply</h4>
<p>Send back list of known (filename, hash, size and peers) for every
file known</p>
<ul>
<li>Operation <code>filelistRes</code></li>
<li>Fields: (see below), the list can be empty</li>
<li>Answer to ‘filelist request’</li>
</ul>
<pre><code>operation:filelistRes
&lt;filename1&gt;:&lt;size1&gt;;&lt;hash1&gt;;&lt;server1a&gt;,&lt;server1b&gt;[...]
&lt;filename2&gt;:&lt;size2&gt;;&lt;hash2&gt;;&lt;server2a&gt;,&lt;server2b&gt;[...]
[...]
</code></pre>
<h4 id="filelist-reply-bad">Filelist reply bad</h4>
<p>Inform client of an error condition on the directory</p>
<ul>
<li>Operation <code>filelistBad</code></li>
<li>Fields: None</li>
<li>Answer to ‘filelist request’</li>
</ul>
<pre><code>operation:filelistBad
</code></pre>
<h4 id="publish-reply">Publish reply</h4>
<p>Acknowledge publish request</p>
<ul>
<li>Operation <code>publishAck</code></li>
<li>Fields: None</li>
<li>Answer to: ‘publish request’</li>
</ul>
<pre><code>operation:publishAck
</code></pre>
<h2 id="peer-protocol">Peer protocol</h2>
<p>Binary little-endian over TCP buffers</p>
<p>All messages begin with an opcode byte</p>
<h3 id="client-requests-1">Client requests</h3>
<h4 id="file-request">File request</h4>
<p>Requests availability of file to be downloaded</p>
<ul>
<li>Opcode: 0x02</li>
<li>Fields:
<ul>
<li>fnamelen: Filename length</li>
</ul></li>
<li>Answer: ‘accepted’ or ‘file not found error’</li>
</ul>
<pre><code>0        1         byte
+--------+--------+
| opcode |fnamelen|
+-----------------+
| filename        |
| ...             |</code></pre>
<h4 id="get-chunk">Get chunk</h4>
<p>Requests availability of file to be downloaded</p>
<ul>
<li>Opcode: 0x04</li>
<li>Fields:
<ul>
<li>offset[8]: Starting byte of chunk</li>
<li>size[4]: Size of chunk</li>
</ul></li>
<li>Answer: ‘chunk served’</li>
</ul>
<pre><code>0        1       2       3       4       5       6       7       8         byte
+--------+----------------------------------------------------------------+
| opcode | offset                                                         |
+--------+----------------------+-----------------------------------------+
| size                          |
+-------------------------------+</code></pre>
<h4 id="stop-download">Stop download</h4>
<ul>
<li>Opcode: 0x05</li>
<li>Fields: None</li>
<li>Answer: None</li>
</ul>
<pre><code>0               
+--------+
| opcode |
+--------+</code></pre>
<h3 id="server-requests">Server requests</h3>
<h4 id="file-not-found-error">File not found error</h4>
<ul>
<li>Opcode: 0x01</li>
<li>Fields: None</li>
<li>Answer to: ‘file request’</li>
</ul>
<pre><code>0               
+--------+
| opcode |
+--------+</code></pre>
<h4 id="accepted">Accepted</h4>
<ul>
<li>Opcode 0x03</li>
<li>Fields: None</li>
<li>Answer to: ‘file request’</li>
</ul>
<pre><code>0               
+--------+
| opcode |
+--------+</code></pre>
<h4 id="chunk-served">Chunk served</h4>
<p>Requests availability of file to be downloaded</p>
<ul>
<li>Opcode: 0x06</li>
<li>Fields:
<ul>
<li>size[4]: Size of chunk</li>
<li>data:</li>
</ul></li>
<li>Answer to: ‘get chunk’</li>
</ul>
<pre><code>0        1       2       3       4       byte
+--------+------------------------------+
| opcode | size                         |
+--------+------------------------------+
| data ...
|</code></pre>
